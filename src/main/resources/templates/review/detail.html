<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{ layout/basic-layout }">
	
<div layout:fragment="content">
<!-- style part -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
<style>
	#writer {
		border: none;
		outline: none;
	}
	
	#heart {
		font-size: 52px;
		color: silver;
	}
	
	#heart:hover {
		color: red;
	}
	
	#heart-full {
		font-size: 52px;
		color: red;
	}
	
	.btnHeart {
		border: none;
		background-color: white;
	}
	
	.star {
		font-size: 32px;
		color: orange;
	}
	
	#title {
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
</style>
<!-- style part end -->

	
	<div style="margin: auto; width: 80%;">
		<input type="hidden" id="reviewId" th:value="${ review.id }"/>
		<div style="border-bottom: thin solid silver; padding: 10px 0; margin-bottom: 5px;">
			<div>
				<div th:text="${ review.title }" style="width: 93%; font-size: 48px; margin-bottom: 20px; display: inline-block;"></div>
				<div style="display: inline-block; vertical-align: top;">
				<th:block sec:authorize="isAuthenticated()">
					<span id="loginUser" sec:authentication="principal.idName" style="display: none;"></span>
					<div th:if="${ heart } == 0">
						<button class="btnHeart" id="heart"><i class="bi bi-hearts"></i></button>
						<button class="btnHeart" id="heart-full" style="display: none;"><i class="bi bi-hearts"></i></button>
					</div>
					<div th:unless="${ heart } == 0">
						<button class="btnHeart" id="heart" style="display: none;"><i class="bi bi-hearts"></i></button>
						<button class="btnHeart" id="heart-full"><i class="bi bi-hearts"></i></button>
					</div>
				</th:block>
				</div>
			</div>
			<div style="color: gray; font-size: small;">
				<div th:text="${ 'by ' + review.author }" style="display: inline-block;"></div>
				<div style="display: inline-block;"><i class="bi bi-alarm" style="margin: 0 5px;"></i><span th:text="${ #temporals.format(review.createdTime, 'yyyy/MM/dd') }"></span></div>
			</div>
			<div style="color: gray; font-size: small;">
				<div>
					<span style="font-size:15px; margin-right: 10px; color:gray;"><i class="bi bi-eye" style="padding-right: 3px;"></i>1500</span>
					<span style="font-size:15px; margin-right: 10px; color:gray;"><i class="bi bi-hearts" style="padding-right: 3px;"></i><span id="countHeart" th:text="${ reviewDto.heart }"></span></span>
				</div>
			</div>
		</div>
		<div th:text="${ review.content }" style="height: 500px; font-size: 18px; white-space: pre-wrap;"></div>
		<div style="margin: 15px 0;">
			<span class="star">★</span>
			<span style="font-size: 18px; font-weight: bold;" th:text="${ ' X ' + review.score }"></span>
		</div>
		<div style="text-align: right;">
			<div th:if="${ #authentication.name } == ${ review.author }">
				<button style="width: 100px; height:35px;">Modify</button>
			</div>
		</div>
		
		<div style="font-size: 18px; font-weight: bold; margin: 10px 0;">댓글 <span id="countReply" style="color: green;" th:text="${ reviewDto.replyCount }"></span></div>
		<div id="replies"></div>
		
		<th:block sec:authorize="isAuthenticated()">
		<div>
			<input type="hidden" id="writer" th:value="${ #authentication.name }"/>
			<div style="border: thin solid silver;">
				<input id="replyText" type="text" style="width: 93%; height: 25px; font-size: 15px; border: none; padding: 10px; outline: none;" placeholder="댓글을 입력해주세요 :)"/>
				<button id="btnReply" style="border: thin solid silver; background-color: white; padding: 8px; border-radius: 15px; color:gray;">Click</button>
			</div>
		</div>
		</th:block>
		
	
		<div style="margin: 50px 0;">
			<div style="font-weight: bold;">최근 올라온 리뷰는?</div>
			<div>
				<div th:each="reviews : ${ otherReviewTopSix }" style="display: inline-block; margin: 10px 12px;">
					<a th:href="@{ /review/detail?reviewId={reviewId} (reviewId = ${ reviews.reviewId }) }">
						<div style="width: 350px; height: 200px; margin: 5px 0; border: 1px solid black;"></div>
						<div id="title" style="width: 350px; font-weight: bold; font-size: 18px;" th:text="${ reviews.title }"></div>
						<div th:text="${ reviews.idName }" style="font-size: 15px;"></div>
						<div th:text="${ #temporals.format(reviews.createdTime, 'yyyy/MM/dd') }" style="font-size: small;"></div>
						<div style="font-size: small;">
							<span style="margin-right: 10px; color:gray;">
								<i class="bi bi-eye" style="padding-right: 3px;"></i>
								<span th:text="${ reviews.watch }"></span>
							</span>
							<span style="margin-right: 10px; color:gray;">
								<i class="bi bi-hearts" style="padding-right: 3px;"></i>
								<span th:text="${ reviews.heart }"></span>
							</span>
							<span style="margin-right: 10px; color:gray;">
								<i class="bi bi-chat-text" style="padding-right: 3px;"></i>
								<span th:text="${ reviews.replyCount }"></span>
							</span>
						</div>
					</a>
				</div>
			</div>
		</div>
	</div>
	
</div><!-- fragment end -->

<th:block layout:fragment="script">
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script th:src="@{ /js/reply.js }"></script>
	<script>
		const reviewIdInput = document.querySelector('#reviewId').value;
		const loginUser = document.querySelector('#loginUser').innerText;
		
		const btnHeartAdd = document.querySelector('#heart');
		const btnHeartDelete = document.querySelector('#heart-full');
		
		let countHeart = document.querySelector('#countHeart').value;
		
		btnHeartAdd.addEventListener('click', () => {
			const reviewId = Number(reviewIdInput);
			
			axios.post('/api/review/heart', null, { params: {reviewId} })
				.then(response => { 
					console.log(response.data); 
					changeFull(response.data);
				})
				.catch(error => { console.log(error); })
		})
		
		function changeFull(data) {
			btnHeartDelete.style.display = '';
			btnHeartAdd.style.display = 'none';
			document.querySelector('#countHeart').innerText = data;
		}
		
		btnHeartDelete.addEventListener('click', () => {
			const reviewId = Number(reviewIdInput);
			
			axios.post('/api/review/heartDelete', null, { params: {reviewId} })
				.then(response => {
					console.log(response.data);
					changeHeart(response.data);
				})
				.catch(error => { console.log(error); })
		})
		
		function changeHeart(data) {
			btnHeartDelete.style.display = 'none';
			btnHeartAdd.style.display = '';
			document.querySelector('#countHeart').innerText = data;
		}
		
	</script>
</th:block>

</html>